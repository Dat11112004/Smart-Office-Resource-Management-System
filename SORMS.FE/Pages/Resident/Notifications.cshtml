@page
@model SORMS.FE.Pages.Resident.NotificationsModel
@{
    ViewData["Title"] = "Thông Báo";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<style>
    .notifications-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

        .page-header h2 {
            margin: 0;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

            .page-header h2 i {
                font-size: 2rem;
            }

        .page-header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }

    .notification-item {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
        position: relative;
    }

        .notification-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .notification-item.unread {
            background: linear-gradient(to right, #f0f3ff 0%, white 100%);
            border-left-color: #667eea;
        }

            .notification-item.unread .notification-badge {
                display: inline-block;
            }

        .notification-item.read {
            opacity: 0.8;
            border-left-color: #e9ecef;
        }

    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .notification-meta {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.875rem;
        color: #6c757d;
    }

    .notification-type {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

        .notification-type.broadcast {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .notification-type.individual {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

    .notification-badge {
        display: none;
        background: #e74c3c;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .notification-message {
        color: #2c3e50;
        line-height: 1.6;
        margin-bottom: 0.75rem;
        white-space: pre-wrap;
    }

    .notification-time {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: #95a5a6;
    }

        .notification-time i {
            font-size: 0.875rem;
        }

    .mark-read-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .mark-read-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .mark-read-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

        .empty-state i {
            font-size: 5rem;
            color: #dfe6e9;
            margin-bottom: 1.5rem;
        }

        .empty-state h4 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: #95a5a6;
        }

    .alert {
        border-radius: 12px;
        border: none;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
    }

    .alert-danger {
        background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        color: white;
    }

    .stats-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        flex: 1;
        background: white;
        padding: 1rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        display: flex;
        align-items: center;
        gap: 1rem;
    }

        .stat-card i {
            font-size: 2rem;
            color: #667eea;
        }

        .stat-card .stat-info h5 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-card .stat-info p {
            margin: 0;
            font-size: 0.875rem;
            color: #6c757d;
        }

    @@media (max-width: 768px) {
        .stats-bar {
            flex-direction: column;
        }

        .notification-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
    }
</style>

<div class="notifications-container">
    <div class="page-header">
        <h2>
            <i class="fas fa-bell"></i>
            Thông Báo
        </h2>
        <p>Quản lý và xem tất cả thông báo của bạn</p>
    </div>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            @Model.ErrorMessage
        </div>
    }

    @if (Model.Notifications.Any())
    {
        <div class="stats-bar">
            <div class="stat-card">
                <i class="fas fa-envelope"></i>
                <div class="stat-info">
                    <h5>@Model.Notifications.Count</h5>
                    <p>Tổng thông báo</p>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-envelope-open"></i>
                <div class="stat-info">
                    <h5>@Model.Notifications.Count(n => !n.IsRead)</h5>
                    <p>Chưa đọc</p>
                </div>
            </div>
        </div>

        <div id="notificationsList">
            @foreach (var notification in Model.Notifications)
            {
                <div class="notification-item @(notification.IsRead ? "read" : "unread")" data-id="@notification.Id">
                    <div class="notification-header">
                        <div class="notification-meta">
                            <span class="notification-type @(notification.Type.ToLower())">
                                <i class="fas @(notification.Type == "Broadcast" ? "fa-bullhorn" : "fa-envelope")"></i>
                                @(notification.Type == "Broadcast" ? "Thông báo chung" : "Thông báo cá nhân")
                            </span>
                            @if (!notification.IsRead)
                            {
                                <span class="notification-badge">MỚI</span>
                            }
                        </div>
                        @* Tạm thời ẩn nút "Đánh dấu đã đọc" do vấn đề kiến trúc với Broadcast notifications *@
                        @* TODO: Implement NotificationUserRead junction table for proper per-user read tracking *@
                    </div>
                    <div class="notification-message">
                        @notification.Message
                    </div>
                    <div class="notification-time">
                        <i class="far fa-clock"></i>
                        <span>@GetTimeAgo(notification.CreatedAt)</span>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <i class="far fa-bell-slash"></i>
            <h4>Không có thông báo nào</h4>
            <p>Bạn chưa nhận được thông báo nào. Các thông báo mới sẽ xuất hiện tại đây.</p>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Event delegation for mark as read buttons
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(e) {
                const button = e.target.closest('.mark-read-btn');
                if (button) {
                    const notificationId = parseInt(button.getAttribute('data-notification-id'));
                    console.log('Marking notification as read:', notificationId);
                    markAsRead(notificationId, button);
                }
            });
        });

        async function markAsRead(notificationId, button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Đang xử lý...';

            try {
                console.log('Sending mark as read request for notification:', notificationId);
                const response = await fetch('?handler=MarkAsRead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ notificationId: notificationId })
                });

                const result = await response.json();
                console.log('Mark as read response:', result);

                if (result.success) {
                    // Update UI
                    const notificationItem = document.querySelector(`[data-id="${notificationId}"]`);
                    notificationItem.classList.remove('unread');
                    notificationItem.classList.add('read');
                    button.remove();

                    // Update badge
                    const badge = notificationItem.querySelector('.notification-badge');
                    if (badge) badge.remove();

                    // Update stats
                    updateStats();

                    // Show success message
                    showToast('Đã đánh dấu là đã đọc', 'success');
                } else {
                    showToast(result.message || 'Không thể đánh dấu đã đọc', 'error');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-check me-1"></i> Đánh dấu đã đọc';
                }
            } catch (error) {
                showToast('Đã xảy ra lỗi khi đánh dấu đã đọc', 'error');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-check me-1"></i> Đánh dấu đã đọc';
            }
        }

        function updateStats() {
            const unreadCount = document.querySelectorAll('.notification-item.unread').length;
            const statCards = document.querySelectorAll('.stat-card .stat-info h5');
            if (statCards.length >= 2) {
                statCards[1].textContent = unreadCount;
            }
        }

        function showToast(message, type) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)' : 'linear-gradient(135deg, #eb3349 0%, #f45c43 100%)'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>${message}`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @@keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @@keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
}

@functions {
    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.Now - dateTime;

        if (timeSpan.TotalMinutes < 1)
            return "Vừa xong";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes} phút trước";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours} giờ trước";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays} ngày trước";
        if (timeSpan.TotalDays < 30)
            return $"{(int)(timeSpan.TotalDays / 7)} tuần trước";
        
        return dateTime.ToString("dd/MM/yyyy HH:mm");
    }
}
