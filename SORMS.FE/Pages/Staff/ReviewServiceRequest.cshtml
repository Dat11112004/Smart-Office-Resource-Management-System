@page "{requestId:int}"
@model SORMS.FE.Pages.Staff.ReviewServiceRequestModel
@{
    ViewData["Title"] = "Xử Lý Yêu Cầu Dịch Vụ";
}

@if (Model.Request == null)
{
    <div style="max-width: 800px; margin: 2rem auto; padding: 2rem; text-align: center; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
        <i class="fas fa-exclamation-circle" style="font-size: 4rem; color: #ef5350; margin-bottom: 1rem;"></i>
        <h4 style="color: #37474f; margin-bottom: 0.5rem;">Không Tìm Thấy Yêu Cầu</h4>
        <p style="color: #90a4ae; margin-bottom: 1.5rem;">Yêu cầu này không tồn tại hoặc đã bị xóa.</p>
        <a href="/Staff/ServiceRequestManagement" class="btn btn-primary">
            <i class="fas fa-arrow-left me-2"></i> Quay Lại Danh Sách
        </a>
    </div>
    return;
}

<style>
    .detail-section {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .detail-row {
        display: flex;
        padding: 1rem 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        flex: 0 0 180px;
        color: #546e7a;
        font-weight: 600;
        font-size: 0.95rem;
    }

    .detail-value {
        flex: 1;
        color: #37474f;
        font-size: 0.95rem;
    }

    .priority-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.8rem;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .priority-low {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        color: #1976d2;
    }

    .priority-normal {
        background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        color: #7b1fa2;
    }

    .priority-high {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        color: #f57c00;
    }

    .priority-urgent {
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        color: #c62828;
        animation: pulse 2s infinite;
    }

    @@keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .review-form {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .form-label {
        color: #546e7a;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border-radius: 10px;
        border: 2px solid #e0e0e0;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }

    .btn-submit {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.875rem 2rem;
        border-radius: 12px;
        border: none;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102,126,234,0.3);
    }

    .btn-back {
        background: linear-gradient(135deg, #90a4ae 0%, #78909c 100%);
        color: white;
        padding: 0.875rem 2rem;
        border-radius: 12px;
        border: none;
        font-weight: 600;
        font-size: 1rem;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
    }

    .btn-back:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(144,164,174,0.3);
        color: white;
    }
</style>

<div style="max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem;">
    
    <!-- Header -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 20px; margin-bottom: 2rem; box-shadow: 0 10px 40px rgba(102,126,234,0.3);">
        <h2 style="font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; color: white;">
            <i class="fas fa-edit"></i> Xử Lý Yêu Cầu Dịch Vụ
        </h2>
        <p style="font-size: 0.95rem; margin: 0; color: white;">Xem chi tiết và cập nhật trạng thái yêu cầu</p>
    </div>

    <div class="row">
        <!-- Left: Request Details -->
        <div class="col-lg-7">
            <div class="detail-section">
                <h4 style="color: #37474f; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-info-circle" style="color: #667eea;"></i>
                    Thông Tin Chi Tiết
                </h4>

                <div class="detail-row">
                    <div class="detail-label">Tiêu đề:</div>
                    <div class="detail-value">
                        <strong style="font-size: 1.1rem;">@Model.Request.Title</strong>
                    </div>
                </div>

                <div class="detail-row">
                    <div class="detail-label">Cư dân:</div>
                    <div class="detail-value">
                        <i class="fas fa-user" style="color: #667eea; margin-right: 0.5rem;"></i>
                        @Model.Request.ResidentName
                    </div>
                </div>

                <div class="detail-row">
                    <div class="detail-label">Loại dịch vụ:</div>
                    <div class="detail-value">
                        <i class="fas fa-tools" style="color: #667eea; margin-right: 0.5rem;"></i>
                        @Model.Request.ServiceType
                    </div>
                </div>

                <div class="detail-row">
                    <div class="detail-label">Độ ưu tiên:</div>
                    <div class="detail-value">
                        <span class="priority-badge priority-@Model.Request.Priority.ToLower()">
                            <i class="fas fa-flag"></i> @Model.Request.Priority
                        </span>
                    </div>
                </div>

                <div class="detail-row">
                    <div class="detail-label">Trạng thái hiện tại:</div>
                    <div class="detail-value">
                        <span class="badge @GetStatusBadgeClass(Model.Request.Status)" style="padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600;">
                            @GetStatusText(Model.Request.Status)
                        </span>
                    </div>
                </div>

                <div class="detail-row">
                    <div class="detail-label">Ngày gửi:</div>
                    <div class="detail-value">
                        <i class="fas fa-calendar" style="color: #667eea; margin-right: 0.5rem;"></i>
                        @Model.Request.RequestDate.ToString("dd/MM/yyyy HH:mm")
                    </div>
                </div>

                <div class="detail-row">
                    <div class="detail-label">Mô tả:</div>
                    <div class="detail-value">
                        <p style="margin: 0; line-height: 1.6; white-space: pre-wrap;">@Model.Request.Description</p>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(Model.Request.StaffFeedback))
                {
                    <div style="margin-top: 1.5rem; padding: 1.5rem; background: rgba(67,233,123,0.1); border-radius: 10px; border-left: 3px solid #43e97b;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <i class="fas fa-user-tie" style="color: #43e97b;"></i>
                            <strong style="color: #43e97b;">Phản hồi từ @Model.Request.ReviewedBy:</strong>
                        </div>
                        <p style="color: #37474f; margin: 0; line-height: 1.6;">@Model.Request.StaffFeedback</p>
                        @if (Model.Request.ReviewedDate.HasValue)
                        {
                            <small style="color: #90a4ae; font-size: 0.85rem; margin-top: 0.75rem; display: block;">
                                <i class="fas fa-clock"></i> @Model.Request.ReviewedDate.Value.ToString("dd/MM/yyyy HH:mm")
                            </small>
                        }
                    </div>
                }

                @if (Model.Request.CompletedDate.HasValue)
                {
                    <div style="margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem; padding: 1rem; background: rgba(38,166,154,0.1); border-radius: 8px;">
                        <i class="fas fa-check-circle" style="color: #26a69a;"></i>
                        <span style="color: #26a69a; font-weight: 600;">
                            Hoàn thành: @Model.Request.CompletedDate.Value.ToString("dd/MM/yyyy HH:mm")
                        </span>
                    </div>
                }
            </div>
        </div>

        <!-- Right: Review Form / View Only -->
        <div class="col-lg-5">
            @if (Model.Request.Status == "Completed" || Model.Request.Status == "Rejected")
            {
                <!-- View Only Mode -->
                <div class="review-form">
                    <h4 style="color: #37474f; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-info-circle" style="color: #667eea;"></i>
                        Thông Tin Xử Lý
                    </h4>

                    <div class="mb-4">
                        <label class="form-label">
                            <i class="fas fa-sync-alt me-2" style="color: #667eea;"></i>
                            Trạng thái:
                        </label>
                        <div style="padding: 0.75rem 1rem; background: #f8f9fa; border-radius: 10px; border: 2px solid #e0e0e0;">
                            <span class="badge @GetStatusBadgeClass(Model.Request.Status)" style="padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; font-size: 0.9rem;">
                                @GetStatusText(Model.Request.Status)
                            </span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">
                            <i class="fas fa-comment-dots me-2" style="color: #667eea;"></i>
                            Phản hồi/Ghi chú:
                        </label>
                        <div style="padding: 1rem; background: #f8f9fa; border-radius: 10px; border: 2px solid #e0e0e0; min-height: 150px; line-height: 1.6; color: #37474f; white-space: pre-wrap;">@Model.Request.StaffFeedback</div>
                    </div>

                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; color: #f57c00;">
                            <i class="fas fa-lock"></i>
                            <strong style="font-size: 0.9rem;">Yêu cầu đã được hoàn tất</strong>
                        </div>
                        <small style="color: #e65100; display: block; margin-top: 0.25rem; font-size: 0.85rem;">
                            Không thể chỉnh sửa yêu cầu đã hoàn thành hoặc bị từ chối
                        </small>
                    </div>

                    <div>
                        <a href="/Staff/ServiceRequestManagement" class="btn-back" style="width: 100%; text-align: center;">
                            <i class="fas fa-arrow-left me-2"></i> Quay Lại Danh Sách
                        </a>
                    </div>
                </div>
            }
            else
            {
                <!-- Edit Mode -->
                <div class="review-form">
                    <h4 style="color: #37474f; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-tasks" style="color: #667eea;"></i>
                        Cập Nhật Yêu Cầu
                    </h4>

                    <form method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="requestId" value="@Model.Request.Id">

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-sync-alt me-2" style="color: #667eea;"></i>
                                Trạng thái:
                            </label>
                            <select class="form-select" name="status" required>
                                <option value="Approved" selected="@(Model.Request.Status == "Pending")">Phê duyệt</option>
                                <option value="InProgress" selected="@(Model.Request.Status == "Approved" || Model.Request.Status == "InProgress")">Đang xử lý</option>
                                <option value="Completed">Hoàn thành</option>
                                <option value="Rejected">Từ chối</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-comment-dots me-2" style="color: #667eea;"></i>
                                Phản hồi/Ghi chú:
                            </label>
                            <textarea class="form-control" name="feedback" rows="6" required placeholder="Nhập phản hồi cho cư dân về yêu cầu này...">@Model.Request.StaffFeedback</textarea>
                            <small style="color: #90a4ae; display: block; margin-top: 0.5rem;">
                                <i class="fas fa-info-circle"></i> Phản hồi này sẽ được hiển thị cho cư dân
                            </small>
                        </div>

                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button type="submit" class="btn-submit" style="flex: 1;">
                                <i class="fas fa-check me-2"></i> Xác Nhận
                            </button>
                            <a href="/Staff/ServiceRequestManagement" class="btn-back">
                                <i class="fas fa-arrow-left me-2"></i> Quay Lại
                            </a>
                        </div>
                    </form>
                </div>

                <!-- Quick Actions Guide -->
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 1.5rem; border-radius: 12px; margin-top: 1.5rem;">
                    <h6 style="color: #1976d2; font-weight: 700; margin-bottom: 1rem;">
                        <i class="fas fa-lightbulb"></i> Hướng dẫn xử lý
                    </h6>
                    <ul style="margin: 0; padding-left: 1.5rem; color: #37474f; font-size: 0.9rem; line-height: 1.8;">
                        <li><strong>Phê duyệt:</strong> Chấp nhận yêu cầu</li>
                        <li><strong>Đang xử lý:</strong> Bắt đầu thực hiện</li>
                        <li><strong>Hoàn thành:</strong> Đã hoàn tất yêu cầu</li>
                        <li><strong>Từ chối:</strong> Không thể thực hiện</li>
                    </ul>
                </div>
            }
        </div>
    </div>

</div>

@functions {
    private string GetStatusText(string status)
    {
        return status switch
        {
            "Pending" => "Chờ xử lý",
            "Approved" => "Đã duyệt",
            "InProgress" => "Đang xử lý",
            "Completed" => "Hoàn thành",
            "Rejected" => "Từ chối",
            _ => status
        };
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "bg-warning text-dark",
            "Approved" => "bg-success",
            "InProgress" => "bg-info text-dark",
            "Completed" => "bg-secondary",
            "Rejected" => "bg-danger",
            _ => "bg-secondary"
        };
    }
}
